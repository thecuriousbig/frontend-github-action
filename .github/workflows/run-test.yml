name: 'run test'

on:
  pull_request_target:
    branches:
      - main
      - dev
    types:
      - opened
  workflow_call:
    inputs:
      call_from:
        required: false
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout github
        uses: actions/checkout@v3
      - name: setup node
        uses: actions/setup-node@v2
        with:
          node-version: '14'
      - name: install dependencies
        run: npm install
      - name: run test [ci mode]
        id: ci-test
        run: npm run test
        env:
          CI: true

  test-result:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: add test's result label
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'test ${{ needs.test.result }}'


  remove-label:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ inputs.call_from }} == 'labeled'
    steps:
      - name: remove ready-to-test label
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          labels: 'ready to test'